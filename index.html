<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Генератор документов</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #document-container {
            position: absolute;
            left: -9999px;
            top: 0;
            width: 800px;
        }
        .render-container {
            position: relative;
            width: 100%;
        }
        .background-image {
            display: block;
            width: 100%;
            height: auto;
        }
        .dynamic-field {
            position: absolute;
            white-space: nowrap;
            padding: 2px;
            font-family: Arial, sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="text-center text-white"><div class="loader mx-auto mb-4"></div><p id="loading-text">Загрузка шаблонов...</p></div>
    </div>

    <div class="container mx-auto p-4 max-w-2xl">
        <header class="text-center mb-6">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-900">Генератор документов</h1>
        </header>

        <div id="selection-screen">
            <h2 class="text-xl font-semibold mb-4 text-center border-b pb-2">Выберите операцию</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                <div id="select-baikal" class="bg-blue-500 text-white p-6 rounded-lg shadow-lg text-center cursor-pointer hover:bg-blue-600 transition-colors">
                    <h3 class="text-2xl font-bold">Байкал Сервис</h3>
                    <p class="mt-2">Создать доверенность и расход</p>
                </div>
                <div id="select-fortuna" class="bg-purple-500 text-white p-6 rounded-lg shadow-lg text-center cursor-pointer hover:bg-purple-600 transition-colors">
                    <h3 class="text-2xl font-bold">Фортуна</h3>
                    <p class="mt-2">Создать акт выдачи</p>
                </div>
            </div>
        </div>

        <div id="form-container" class="hidden mt-8">
             <button id="back-to-selection" class="mb-4 bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">← Назад</button>
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h2 id="form-title" class="text-xl font-semibold mb-4 border-b pb-3">Общие данные</h2>
                <form id="data-form" class="space-y-4 mt-4">
                    </form>
            </div>
             <div id="generator-buttons" class="mt-6 pt-4 border-t">
                 </div>
        </div>
    </div>

    <div id="document-container">
        <div id="baikal-container" class="render-container"><img id="baikal-background-image" class="background-image" src="" /></div>
        <div id="fortuna-container" class="render-container"><img id="fortuna-background-image" class="background-image" src="" /></div>
    </div>

<script>
// --- GLOBAL VARIABLES ---
const { jsPDF } = window.jspdf;
let baikalTemplateFile = null;
let fortunaTemplateFile = null;
let excelTemplateFile = null;

// --- TEMPLATE DATA ---
const baikalTemplateData = [
    {"id":"b_doc_num",    "top":"6.36%", "left":"68.00%","width":"11.00%","fontSize":"11.5pt","fontWeight":"bold"},
    {"id":"b_fio",        "top":"38.42%","left":"10.25%","width":"82.50%","fontSize":"11.5pt","fontWeight":"bold"},
    {"id":"b_passport",   "top":"43.89%","left":"10.25%","width":"82.50%","fontSize":"11.5pt","fontWeight":"bold"},
    {"id":"b_exp_day",    "top":"65.18%","left":"53.00%","width":"4.00%", "fontSize":"12pt"},
    {"id":"b_exp_month",  "top":"65.09%","left":"58.88%","width":"19.00%","fontSize":"12pt"},
    {"id":"b_exp_year",   "top":"65.11%","left":"79.13%","width":"4.50%", "fontSize":"13pt"},
    {"id":"b_issue_day",  "top":"12.19%","left":"68.63%","width":"4.00%", "fontSize":"12pt"},
    {"id":"b_issue_month","top":"12.10%","left":"74.13%","width":"13.00%","fontSize":"12pt"},
    {"id":"b_issue_year", "top":"12.20%","left":"87.63%","width":"3.50%", "fontSize":"12.6pt"}
];

// --- ИЗМЕНЕНИЯ ЗДЕСЬ ---
const fortunaTemplateData = [
    {
        "id": "f_fio",
        "top": "16.17%",
        "left": "7.25%",
        "width": "34.38%",
        "fontSize": "7.8pt",
        "fontWeight": "normal",
        "align": "center"
    },
    {
        "id": "f_doc_num",
        "top": "24.82%",
        "left": "46.75%",
        "width": "14.00%",
        "fontSize": "8pt",
        "fontWeight": "normal",
        "align": "center"
    },
    {
        "id": "f_date",
        "top": "24.83%",
        "left": "60.50%",
        "width": "13.25%",
        "fontSize": "8pt",
        "fontWeight": "normal",
        "align": "center"
    },
    {
        "id": "f_engine",
        "top": "37.19%",
        "left": "10.25%",
        "width": "11.88%",
        "fontSize": "6pt",
        "fontWeight": "normal",
        "align": "left"
    },
    {
        "id": "f_price1",
        "top": "37.19%",
        "left": "53.75%",
        "width": "6.88%",
        "fontSize": "6pt",
        "fontWeight": "normal",
        "align": "right"
    },
    {
        "id": "f_price2",
        "top": "37.19%",
        "left": "60.50%",
        "width": "7.12%",
        "fontSize": "6pt",
        "fontWeight": "normal",
        "align": "right"
    },
    {
        "id": "f_total1",
        "top": "42.67%",
        "left": "60.50%",
        "width": "7.12%",
        "fontSize": "6pt",
        "fontWeight": "normal",
        "align": "right"
    },
    {
        "id": "f_total2",
        "top": "43.73%",
        "left": "60.50%",
        "width": "7.12%",
        "fontSize": "6pt",
        "fontWeight": "normal",
        "align": "right"
    },
    {
        "id": "f_city",
        "top": "10.80%",
        "left": "7.00%",
        "width": "14.00%",
        "fontSize": "8pt",
        "fontWeight": "normal",
        "align": "left"
    }
];

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', async () => {
    populateRenderContainer('baikal-container', baikalTemplateData);
    populateRenderContainer('fortuna-container', fortunaTemplateData);
    setupNavigation();

    try {
        await loadAllTemplates();
    } catch (error) {
        document.getElementById('loading-text').textContent = 'Ошибка загрузки шаблонов!';
        console.error(error);
        alert('Не удалось загрузить шаблоны. Проверьте консоль (F12) для подробностей и убедитесь, что файлы есть в репозитории.');
    } finally {
        hideLoading();
    }
});

function populateRenderContainer(containerId, data) {
    const container = document.getElementById(containerId);
    data.forEach(item => {
        const field = document.createElement('div');
        field.id = item.id;
        field.className = 'dynamic-field';
        field.style.top = item.top;
        field.style.left = item.left;
        field.style.width = item.width;
        field.style.fontSize = item.fontSize;
        field.style.fontWeight = item.fontWeight || 'normal';
        field.style.textAlign = item.align || 'left';
        // Для Байкала нужен другой шрифт, применяем его отдельно
        if (containerId === 'baikal-container') {
            field.style.fontFamily = "'Times New Roman', Times, serif";
        }
        container.appendChild(field);
    });
}

function setupNavigation() {
    document.getElementById('select-baikal').addEventListener('click', () => showFormScreen('baikal'));
    document.getElementById('select-fortuna').addEventListener('click', () => showFormScreen('fortuna'));
    document.getElementById('back-to-selection').addEventListener('click', showSelectionScreen);
}

// --- FILE HANDLING (Simple relative path method) ---
async function loadFile(url, type, elementId) {
    const response = await fetch(url);
    if (!response.ok) {
        throw new Error(`Ошибка загрузки ${url}: ${response.statusText}`);
    }
    
    if (type === 'image') {
        const blob = await response.blob();
        document.getElementById(elementId).src = URL.createObjectURL(blob);
    } else { // excel
        return await response.arrayBuffer();
    }
}

async function loadAllTemplates() {
    // Загружаем файлы по простому относительному пути
    await Promise.all([
        loadFile('baikal.jpg', 'image', 'baikal-background-image'),
        loadFile('fortuna.jpg', 'image', 'fortuna-background-image')
    ]);
    excelTemplateFile = await loadFile('baikal_rashod.xlsx', 'excel');
}


// --- UI FLOW CONTROL ---
function showSelectionScreen() {
    document.getElementById('form-container').classList.add('hidden');
    document.getElementById('selection-screen').classList.remove('hidden');
}

function showFormScreen(type) {
    document.getElementById('selection-screen').classList.add('hidden');
    document.getElementById('form-container').classList.remove('hidden');

    const form = document.getElementById('data-form');
    const buttons = document.getElementById('generator-buttons');
    let formHTML = `
        <div><label for="input_doc_num" class="block text-sm font-medium">Номер документа</label><input type="text" id="input_doc_num" class="mt-1 block w-full p-2 border rounded-md" placeholder="Ю-123"></div>
        <div><label for="input_date" class="block text-sm font-medium">Дата</label><input type="date" id="input_date" class="mt-1 block w-full p-2 border rounded-md"></div>
        <div><label for="input_city" class="block text-sm font-medium">Город</label><input type="text" id="input_city" class="mt-1 block w-full p-2 border rounded-md" placeholder="Сургут"></div>
        <div><label for="input_recipient_name" class="block text-sm font-medium">ФИО получателя</label><input type="text" id="input_recipient_name" class="mt-1 block w-full p-2 border rounded-md" placeholder="Иванов Иван Иванович"></div>
        <div><label for="input_engine_model" class="block text-sm font-medium">Модель двигателя</label><input type="text" id="input_engine_model" class="mt-1 block w-full p-2 border rounded-md" placeholder="G4FC"></div>
        <div><label for="input_amount" class="block text-sm font-medium">Цена</label><input type="number" id="input_amount" class="mt-1 block w-full p-2 border rounded-md" placeholder="185000"></div>
    `;
    let buttonsHTML = '';
    let formTitle = '';

    if (type === 'baikal') {
        formTitle = 'Данные для "Байкал Сервис"';
        formHTML += `
        <div>
            <label for="input_recipient_id" class="block text-sm font-medium text-gray-700">Данные получателя (паспорт/ВУ)</label>
            <textarea id="input_recipient_id" rows="3" class="mt-1 block w-full p-2 border rounded-md" placeholder="паспорт 00 00 123456..."></textarea>
        </div>`;
        buttonsHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <button id="generate-baikal-pdf" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">Скачать Доверенность (PDF)</button>
            <button id="generate-excel" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700">Скачать Расход (Excel)</button>
        </div>`;
    } else if (type === 'fortuna') {
        formTitle = 'Данные для "Фортуна"';
        buttonsHTML = `<button id="generate-fortuna-pdf" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700">Скачать Акт выдачи (PDF)</button>`;
    }

    document.getElementById('form-title').innerText = formTitle;
    form.innerHTML = formHTML;
    document.getElementById('input_date').value = new Date().toISOString().slice(0, 10);
    buttons.innerHTML = buttonsHTML;

    if (type === 'baikal') {
        document.getElementById('generate-baikal-pdf').addEventListener('click', generateBaikalPdf);
        document.getElementById('generate-excel').addEventListener('click', generateExcel);
    }
    if (type === 'fortuna') {
        document.getElementById('generate-fortuna-pdf').addEventListener('click', generateFortunaPdf);
    }
}

// --- FILE NAMING ---
function createFileName() {
    const dateValue = document.getElementById('input_date').value;
    const datePart = dateValue ? dateValue.split('-').reverse().join('.') : '';
    const cityPart = document.getElementById('input_city').value;
    const enginePart = document.getElementById('input_engine_model').value;
    const fullName = document.getElementById('input_recipient_name').value;
    const lastNamePart = fullName ? fullName.split(' ')[0] : '';

    return [datePart, cityPart, enginePart, lastNamePart].filter(Boolean).join(' ');
}

// --- DOCUMENT GENERATION LOGIC ---

// BAIKAL PDF
function updateBaikalDocument() {
    document.getElementById('b_doc_num').innerText = document.getElementById('input_doc_num').value;
    document.getElementById('b_fio').innerText = document.getElementById('input_recipient_name').value;
    document.getElementById('b_passport').innerText = document.getElementById('input_recipient_id').value || '';
    const dateValue = document.getElementById('input_date').value;
    if (dateValue) {
        const d = new Date(dateValue);
        const months = ["Января","Февраля","Марта","Апреля","Мая","Июня","Июля","Августа","Сентября","Октября","Ноября","Декабря"];
        const day = String(d.getDate()).padStart(2, '0');
        const month = months[d.getMonth()];
        const year = String(d.getFullYear()).slice(2);
        ['b_issue_day', 'b_exp_day'].forEach(id => document.getElementById(id).innerText = day);
        ['b_issue_month', 'b_exp_month'].forEach(id => document.getElementById(id).innerText = month);
        ['b_issue_year', 'b_exp_year'].forEach(id => document.getElementById(id).innerText = year);
    }
}
async function generateBaikalPdf() {
    showLoading('Подготовка PDF...');
    updateBaikalDocument();
    try {
        await new Promise(resolve => setTimeout(resolve, 100));
        const container = document.getElementById('baikal-container');
        const canvas = await html2canvas(container, { scale: 3, useCORS: true });
        const imgData = canvas.toDataURL('image/jpeg', 1.0);
        const pdf = new jsPDF({ orientation: 'p', unit: 'px', format: 'a4' });
        pdf.addImage(imgData, 'JPEG', 0, 0, pdf.internal.pageSize.getWidth(), pdf.internal.pageSize.getHeight());
        pdf.save(createFileName() + '.pdf');
    } catch (error) {
        alert("Ошибка при создании PDF: " + error.message);
    } finally {
        hideLoading();
    }
}

// FORTUNA PDF
// --- ИЗМЕНЕНИЯ ЗДЕСЬ ---
function updateFortunaDocument() {
    const dateValue = document.getElementById('input_date').value;
    const formattedDate = dateValue ? dateValue.split('-').reverse().join('.') : '';
    const price = parseFloat(document.getElementById('input_amount').value);
    const formattedPrice = !isNaN(price) ? price.toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '0,00';
    
    document.getElementById('f_city').innerText = document.getElementById('input_city').value;
    document.getElementById('f_fio').innerText = document.getElementById('input_recipient_name').value;
    document.getElementById('f_doc_num').innerText = document.getElementById('input_doc_num').value;
    document.getElementById('f_date').innerText = formattedDate;
    document.getElementById('f_engine').innerText = document.getElementById('input_engine_model').value;
    ['f_price1', 'f_price2', 'f_total1', 'f_total2'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.innerText = formattedPrice;
    });
}
async function generateFortunaPdf() {
    showLoading('Подготовка PDF...');
    updateFortunaDocument();
    try {
        await new Promise(resolve => setTimeout(resolve, 100));
        const container = document.getElementById('fortuna-container');
        const canvas = await html2canvas(container, { scale: 3, useCORS: true });
        const imgData = canvas.toDataURL('image/jpeg', 1.0);
        const pdf = new jsPDF({ orientation: 'p', unit: 'px', format: 'a4' });
        pdf.addImage(imgData, 'JPEG', 0, 0, pdf.internal.pageSize.getWidth(), pdf.internal.pageSize.getHeight());
        pdf.save(createFileName() + '.pdf');
    } catch (error) {
        alert("Ошибка при создании PDF: " + error.message);
    } finally {
        hideLoading();
    }
}

// EXCEL
async function generateExcel() {
    showLoading('Подготовка Excel...');
    try {
        const workbook = new ExcelJS.Workbook();
        await workbook.xlsx.load(excelTemplateFile);
        const worksheet = workbook.getWorksheet(1);
        const dateValue = document.getElementById('input_date').value;
        worksheet.getCell('B2').value = dateValue ? dateValue.split('-').reverse().join('.') : '';
        worksheet.getCell('A7').value = document.getElementById('input_engine_model').value;
        const price = parseFloat(document.getElementById('input_amount').value);
        if (!isNaN(price)) {
            worksheet.getCell('E7').value = price;
            worksheet.getCell('F7').value = price;
        }
        const buffer = await workbook.xlsx.writeBuffer();
        saveAs(new Blob([buffer]), createFileName() + '.xlsx');
    } catch (error) {
        alert("Ошибка при создании Excel файла: " + error.message);
    } finally {
        hideLoading();
    }
}

// --- LOADING OVERLAY ---
function showLoading(message) {
    const loadingText = document.getElementById('loading-text');
    if (loadingText) loadingText.textContent = message;
    const overlay = document.getElementById('loading-overlay');
    if (overlay) overlay.classList.remove('hidden');
}
function hideLoading() {
    const overlay = document.getElementById('loading-overlay');
    if (overlay) overlay.classList.add('hidden');
}
</script>

</body>
</html>
