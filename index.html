<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Генератор документов</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #document-container { position: absolute; left: -9999px; top: 0; width: 800px; }
        .render-container { position: relative; width: 100%; background-color: white; }
        .background-image { display: block; width: 100%; height: auto; }
        .data-field { position: absolute; font-family: Arial, sans-serif; color: black; }

        /* Specific styles for ATEK fields */
        #a_fio { white-space: normal; word-wrap: break-word; line-height: 1.2; }
        #a_shapka, #a_dvs { white-space: nowrap; }
        .custom-underline { text-decoration: underline; text-decoration-thickness: 2px; text-underline-offset: 7px; }

    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="text-center text-white"><div class="loader mx-auto mb-4"></div><p id="loading-text">Загрузка шаблонов...</p></div>
    </div>

    <div class="container mx-auto p-4 max-w-2xl">
        <header class="text-center mb-6">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-900">Генератор документов</h1>
        </header>

        <div id="selection-screen">
            <h2 class="text-xl font-semibold mb-4 text-center border-b pb-2">Выберите операцию</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-4">
                <div id="select-baikal" class="bg-blue-500 text-white p-6 rounded-lg shadow-lg text-center cursor-pointer hover:bg-blue-600 transition-colors">
                    <h3 class="text-xl font-bold">Байкал Сервис</h3>
                </div>
                <div id="select-fortuna" class="bg-purple-500 text-white p-6 rounded-lg shadow-lg text-center cursor-pointer hover:bg-purple-600 transition-colors">
                    <h3 class="text-xl font-bold">Фортуна</h3>
                </div>
                <div id="select-atek" class="bg-teal-500 text-white p-6 rounded-lg shadow-lg text-center cursor-pointer hover:bg-teal-600 transition-colors">
                    <h3 class="text-xl font-bold">АТЭК</h3>
                </div>
            </div>
        </div>

        <div id="form-container" class="hidden mt-8">
             <button id="back-to-selection" class="mb-4 bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">← Назад</button>
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h2 id="form-title" class="text-xl font-semibold mb-4 border-b pb-3">Общие данные</h2>
                <form id="data-form" class="space-y-4 mt-4"></form>
            </div>
             <div id="generator-buttons" class="mt-6 pt-4 border-t"></div>
        </div>
    </div>

    <!-- Hidden containers for PDF rendering -->
    <div id="document-container">
        <div id="baikal-container" class="render-container"><img id="baikal-background-image" class="background-image" src="" /></div>
        <div id="fortuna-container" class="render-container"><img id="fortuna-background-image" class="background-image" src="" /></div>
        <div id="atek-container" class="render-container"><img id="atek-background-image" class="background-image" src="" /></div>
    </div>

<script>
// --- GLOBAL VARIABLES ---
const { jsPDF } = window.jspdf;
let excelTemplateFile = null;

// --- TEMPLATE DATA ---
const baikalTemplateData = [
    {"id":"b_doc_num", "top":"6.36%", "left":"68.00%","width":"11.00%","fontSize":"11.5pt","fontWeight":"bold"},
    {"id":"b_fio", "top":"38.42%","left":"10.25%","width":"82.50%","fontSize":"11.5pt","fontWeight":"bold"},
    {"id":"b_passport", "top":"43.89%","left":"10.25%","width":"82.50%","fontSize":"11.5pt","fontWeight":"bold"},
    {"id":"b_exp_day", "top":"65.18%","left":"53.00%","width":"4.00%", "fontSize":"12pt"},
    {"id":"b_exp_month", "top":"65.09%","left":"58.88%","width":"19.00%","fontSize":"12pt"},
    {"id":"b_exp_year", "top":"65.11%","left":"79.13%","width":"4.50%", "fontSize":"13pt"},
    {"id":"b_issue_day", "top":"12.19%","left":"68.63%","width":"4.00%", "fontSize":"12pt"},
    {"id":"b_issue_month","top":"12.10%","left":"74.13%","width":"13.00%","fontSize":"12pt"},
    {"id":"b_issue_year", "top":"12.20%","left":"87.63%","width":"3.50%", "fontSize":"12.6pt"}
];

// --- ИЗМЕНЕНИЕ ЗДЕСЬ: Обновленные координаты для Фортуны ---
const fortunaTemplateData = [
    {
        "id": "f_fio",
        "top": "16.3%", // Adjusted in previous step
        "left": "7.25%",
        "width": "34.38%",
        "fontSize": "7.8pt",
        "fontWeight": "normal",
        "align": "center"
    },
    {
        "id": "f_doc_num",
        "top": "24.95%", // Adjusted in previous step
        "left": "46.75%",
        "width": "14.00%",
        "fontSize": "8pt",
        "fontWeight": "normal",
        "align": "center"
    },
    {
        "id": "f_date",
        "top": "24.95%", // Adjusted in previous step
        "left": "60.50%",
        "width": "13.25%",
        "fontSize": "8pt",
        "fontWeight": "normal",
        "align": "center"
    },
    {
        "id": "f_engine",
        "top": "37.40%", // Adjusted +0.1%
        "left": "10.80%", // Adjusted in previous step
        "width": "11.88%",
        "fontSize": "6pt",
        "fontWeight": "normal",
        "align": "left"
    },
    {
        "id": "f_price1",
        "top": "37.40%", // Adjusted +0.1%
        "left": "53.60%", // Adjusted in previous step
        "width": "6.88%",
        "fontSize": "6pt",
        "fontWeight": "normal",
        "align": "right"
    },
    {
        "id": "f_price2",
        "top": "37.40%", // Adjusted +0.1%
        "left": "60.25%", // Adjusted in previous step
        "width": "7.12%",
        "fontSize": "6pt",
        "fontWeight": "normal",
        "align": "right"
    },
    {
        "id": "f_total1",
        "top": "42.90%", // Adjusted +0.1%
        "left": "60.25%", // Adjusted in previous step
        "width": "7.12%",
        "fontSize": "6pt",
        "fontWeight": "normal",
        "align": "right"
    },
    {
        "id": "f_total2",
        "top": "43.95%", // Adjusted +0.1%
        "left": "60.25%", // Adjusted in previous step
        "width": "7.12%",
        "fontSize": "6pt",
        "fontWeight": "normal",
        "align": "right"
    },
    {
        "id": "f_city",
        "top": "10.95%", // Adjusted in previous step
        "left": "7.00%",
        "width": "14.00%",
        "fontSize": "8pt",
        "fontWeight": "normal",
        "align": "left"
    }
];

const atekTemplateData = [
    { "id": "a_fio", "top": "21.82%", "left": "30.80%", "width": "51.00%", "fontSize": "12pt", "align": "left", "fontWeight": "normal" },
    { "id": "a_shapka", "top": "9.75%", "left": "13.3%", "width": "68.38%", "fontSize": "12pt", "align": "left", "fontWeight": "bold" },
    { "id": "a_dvs", "top": "34.18%", "left": "18.80%", "width": "16.75%", "fontSize": "10pt", "align": "left", "fontWeight": "normal" },
];

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', async () => {
    if (document.getElementById('baikal-container')) {
        populateRenderContainer('baikal-container', baikalTemplateData);
    } else { console.error("Container 'baikal-container' not found"); }
    
    if (document.getElementById('fortuna-container')) {
        populateRenderContainer('fortuna-container', fortunaTemplateData);
    } else { console.error("Container 'fortuna-container' not found"); }
    
    if (document.getElementById('atek-container')) {
        populateRenderContainer('atek-container', atekTemplateData);
    } else { console.error("Container 'atek-container' not found"); }

    setupNavigation();

    try {
        await loadAllTemplates(); // Загружаем все шаблоны
    } catch (error) {
        document.getElementById('loading-text').textContent = 'Ошибка загрузки шаблонов!';
        console.error("Error during loadAllTemplates:", error);
        alert('Не удалось загрузить один или несколько шаблонов. Проверьте консоль (F12) для подробностей.');
    } finally {
        hideLoading(); 
    }
});

function setupNavigation() {
    const baikalBtn = document.getElementById('select-baikal');
    const fortunaBtn = document.getElementById('select-fortuna');
    const atekBtn = document.getElementById('select-atek');
    const backBtn = document.getElementById('back-to-selection');

    if (baikalBtn) baikalBtn.addEventListener('click', () => showFormScreen('baikal'));
    else console.error("Button 'select-baikal' not found");
    
    if (fortunaBtn) fortunaBtn.addEventListener('click', () => showFormScreen('fortuna'));
    else console.error("Button 'select-fortuna' not found");

    if (atekBtn) atekBtn.addEventListener('click', () => showFormScreen('atek'));
    else console.error("Button 'select-atek' not found");

    if (backBtn) backBtn.addEventListener('click', showSelectionScreen);
    else console.error("Button 'back-to-selection' not found");
}

// --- UI FLOW CONTROL ---
function showSelectionScreen() {
    const formCont = document.getElementById('form-container');
    const selScreen = document.getElementById('selection-screen');
    if (formCont) formCont.classList.add('hidden');
    if (selScreen) selScreen.classList.remove('hidden');
}

function showFormScreen(type) {
    const selScreen = document.getElementById('selection-screen');
    const formCont = document.getElementById('form-container');
    if (selScreen) selScreen.classList.add('hidden');
    if (formCont) formCont.classList.remove('hidden');

    const form = document.getElementById('data-form');
    const buttons = document.getElementById('generator-buttons');
    const formTitleEl = document.getElementById('form-title');
    
    if (!form || !buttons || !formTitleEl) {
        console.error("Form elements not found, cannot show form screen.");
        return;
    }

    let formHTML = `
        <div><label for="input_doc_num" class="block text-sm font-medium">Номер документа</label><input type="text" id="input_doc_num" class="mt-1 block w-full p-2 border rounded-md" placeholder="Ю-123"></div>
        <div><label for="input_date" class="block text-sm font-medium">Дата</label><input type="date" id="input_date" class="mt-1 block w-full p-2 border rounded-md"></div>
        <div><label for="input_city" class="block text-sm font-medium">Город</label><input type="text" id="input_city" class="mt-1 block w-full p-2 border rounded-md" placeholder="Сургут"></div>
        <div><label for="input_recipient_name" class="block text-sm font-medium">ФИО получателя</label><input type="text" id="input_recipient_name" class="mt-1 block w-full p-2 border rounded-md" placeholder="Иванов Иван Иванович"></div>
        <div><label for="input_engine_model" class="block text-sm font-medium">Модель двигателя</label><input type="text" id="input_engine_model" class="mt-1 block w-full p-2 border rounded-md" placeholder="G4FC"></div>
        <div><label for="input_amount" class="block text-sm font-medium">Цена</label><input type="number" id="input_amount" class="mt-1 block w-full p-2 border rounded-md" placeholder="185000"></div>
    `;
    let buttonsHTML = '';
    let formTitle = '';

    if (type === 'baikal') {
        formTitle = 'Данные для "Байкал Сервис"';
        formHTML += `<div><label for="input_recipient_id" class="block text-sm font-medium">Данные получателя (паспорт/ВУ)</label><textarea id="input_recipient_id" rows="3" class="mt-1 block w-full p-2 border rounded-md" placeholder="паспорт 00 00 123456..."></textarea></div>`;
        buttonsHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4"><button id="generate-baikal-pdf" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">Скачать Доверенность (PDF)</button><button id="generate-excel" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700">Скачать Расход (Excel)</button></div>`;
    } else if (type === 'fortuna') {
        formTitle = 'Данные для "Фортуна"';
        buttonsHTML = `<button id="generate-fortuna-pdf" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700">Создать акт выдачи</button>`;
    } else if (type === 'atek') {
        formTitle = 'Данные для "АТЭК"';
        formHTML = `
            <div><label for="input_doc_num" class="block text-sm font-medium">Номер заявки</label><input type="text" id="input_doc_num" class="mt-1 block w-full p-2 border rounded-md" placeholder="Ю030"></div>
            <div><label for="input_date" class="block text-sm font-medium">Дата</label><input type="date" id="input_date" class="mt-1 block w-full p-2 border rounded-md"></div>
             <div><label for="input_city" class="block text-sm font-medium">Город (для названия файла)</label><input type="text" id="input_city" class="mt-1 block w-full p-2 border rounded-md" placeholder="Сургут"></div>
            <div><label for="input_recipient_name" class="block text-sm font-medium">ФИО и паспортные данные</label><input type="text" id="input_recipient_name" class="mt-1 block w-full p-2 border rounded-md" placeholder="Иванов Иван Иванович, паспорт..."></div>
            <div><label for="input_engine_model" class="block text-sm font-medium">Модель двигателя</label><input type="text" id="input_engine_model" class="mt-1 block w-full p-2 border rounded-md" placeholder="G4FC"></div>
        `;
        buttonsHTML = `<button id="generate-atek-pdf" class="w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700">Скачать Заявку (PDF)</button>`;
    }

    formTitleEl.innerText = formTitle;
    form.innerHTML = formHTML;
    
    const dateInput = document.getElementById('input_date');
    if (dateInput) dateInput.valueAsDate = new Date();
    
    buttons.innerHTML = buttonsHTML;

    // Reattach event listeners after updating innerHTML
    if (type === 'baikal') {
        const baikalPdfBtn = document.getElementById('generate-baikal-pdf');
        const excelBtn = document.getElementById('generate-excel');
        if (baikalPdfBtn) baikalPdfBtn.addEventListener('click', generateBaikalPdf);
        if (excelBtn) excelBtn.addEventListener('click', generateExcel);
    }
    if (type === 'fortuna') {
        const fortunaPdfBtn = document.getElementById('generate-fortuna-pdf');
        if (fortunaPdfBtn) fortunaPdfBtn.addEventListener('click', generateFortunaPdf);
    }
    if (type === 'atek') {
         const atekPdfBtn = document.getElementById('generate-atek-pdf');
         if (atekPdfBtn) atekPdfBtn.addEventListener('click', generateAtekPdf);
    }
}

// --- FILE HANDLING ---
async function loadFile(url, type, elementId) {
    const response = await fetch(url);
    if (!response.ok) {
        throw new Error(`Ошибка загрузки ${url}: ${response.statusText}`);
    }

    if (type === 'image') {
        const blob = await response.blob();
        const el = document.getElementById(elementId);
        if (el) {
            el.src = URL.createObjectURL(blob);
        } else {
            console.error(`Element with ID "${elementId}" not found for image.`);
        }
    } else { // excel
        return await response.arrayBuffer();
    }
}

async function loadAllTemplates() {
    await Promise.all([
        loadFile('./baikal.jpg', 'image', 'baikal-background-image'),
        loadFile('./fortuna.jpg', 'image', 'fortuna-background-image'),
        loadFile('./atek.jpg', 'image', 'atek-background-image')
    ]);
    excelTemplateFile = await loadFile('./baikal_rashod.xlsx', 'excel');
}


// --- DOCUMENT GENERATION ---
function createFileName() {
    const dateValue = document.getElementById('input_date')?.value;
    const datePart = dateValue ? dateValue.split('-').reverse().join('.') : '';
    const cityPart = document.getElementById('input_city')?.value || '';
    const enginePart = document.getElementById('input_engine_model')?.value || '';
    const fullName = document.getElementById('input_recipient_name')?.value || '';
    const lastNamePart = fullName ? fullName.split(' ')[0] : '';
    return [datePart, cityPart, enginePart, lastNamePart].filter(Boolean).join(' ') + '.pdf';
}

async function generatePdfFor(containerId) {
    const container = document.getElementById(containerId);
    if (!container) {
         alert(`Ошибка: Не найден контейнер ${containerId}`);
         return;
    }
    const image = container.querySelector('.background-image');
    if (!image) {
         alert(`Ошибка: Не найдено фоновое изображение в ${containerId}`);
         return;
    }


    if (!image.src || image.naturalWidth === 0) {
        alert("Шаблон для этого документа не загружен. Убедитесь, что файл " + containerId.replace('-container','.jpg') + " есть в репозитории и обновите страницу.");
        return;
    }

    showLoading('Подготовка PDF...');
    try {
        await new Promise(r => setTimeout(r, 100)); // Allow time for rendering
        const canvas = await html2canvas(container, { scale: 3, useCORS: true });
        const imgData = canvas.toDataURL('image/jpeg', 1.0);
        const pdf = new jsPDF({ orientation: 'p', unit: 'px', format: 'a4' });
        pdf.addImage(imgData, 'JPEG', 0, 0, pdf.internal.pageSize.getWidth(), pdf.internal.pageSize.getHeight());
        pdf.save(createFileName());
    } catch (error) {
        alert("Ошибка при создании PDF: " + error.message);
        console.error("PDF Generation Error:", error);
    } finally {
        hideLoading();
    }
}

// --- Specific Generation Functions ---
const generateBaikalPdf = () => { updateBaikalDocument(); generatePdfFor('baikal-container'); };
const generateFortunaPdf = () => { updateFortunaDocument(); generatePdfFor('fortuna-container'); };
const generateAtekPdf = () => { updateAtekDocument(); generatePdfFor('atek-container'); };

// --- Document Update Functions ---
function updateBaikalDocument() {
    const docNumEl = document.getElementById('b_doc_num');
    const fioEl = document.getElementById('b_fio');
    const passportEl = document.getElementById('b_passport');
    const inputDocNumEl = document.getElementById('input_doc_num');
    const inputRecipientNameEl = document.getElementById('input_recipient_name');
    const inputRecipientIdEl = document.getElementById('input_recipient_id');
    const inputDateEl = document.getElementById('input_date');

    if (docNumEl && inputDocNumEl) docNumEl.innerText = inputDocNumEl.value;
    if (fioEl && inputRecipientNameEl) fioEl.innerText = inputRecipientNameEl.value;
    if (passportEl && inputRecipientIdEl) passportEl.innerText = inputRecipientIdEl.value || '';
    
    if (inputDateEl && inputDateEl.value) {
        const dateValue = inputDateEl.value;
        const d = new Date(dateValue);
        const months = ["Января","Февраля","Марта","Апреля","Мая","Июня","Июля","Августа","Сентября","Октября","Ноября","Декабря"];
        const day = String(d.getDate()).padStart(2, '0');
        const month = months[d.getMonth()];
        const year = String(d.getFullYear()).slice(2);
        
        ['b_issue_day', 'b_exp_day'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.innerText = day;
        });
        ['b_issue_month', 'b_exp_month'].forEach(id => {
             const el = document.getElementById(id);
             if (el) el.innerText = month;
        });
        ['b_issue_year', 'b_exp_year'].forEach(id => {
             const el = document.getElementById(id);
             if (el) el.innerText = year;
        });
    }
}
function updateFortunaDocument() {
    const inputDateEl = document.getElementById('input_date');
    const inputAmountEl = document.getElementById('input_amount');
    const inputCityEl = document.getElementById('input_city');
    const inputRecipientNameEl = document.getElementById('input_recipient_name');
    const inputDocNumEl = document.getElementById('input_doc_num');
    const inputEngineModelEl = document.getElementById('input_engine_model');

    const dateValue = inputDateEl?.value;
    const formattedDate = dateValue ? dateValue.split('-').reverse().join('.') : '';
    const price = inputAmountEl ? parseFloat(inputAmountEl.value) : NaN;
    const formattedPrice = !isNaN(price) ? price.toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '0,00';
    
    const cityEl = document.getElementById('f_city');
    const fioEl = document.getElementById('f_fio');
    const docNumEl = document.getElementById('f_doc_num');
    const dateEl = document.getElementById('f_date');
    const engineEl = document.getElementById('f_engine');

    if (cityEl && inputCityEl) cityEl.innerText = inputCityEl.value;
    if (fioEl && inputRecipientNameEl) fioEl.innerText = inputRecipientNameEl.value;
    if (docNumEl && inputDocNumEl) docNumEl.innerText = inputDocNumEl.value;
    if (dateEl) dateEl.innerText = formattedDate;
    if (engineEl && inputEngineModelEl) engineEl.innerText = inputEngineModelEl.value;
    
    ['f_price1', 'f_price2', 'f_total1', 'f_total2'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.innerText = formattedPrice;
    });
}

function updateAtekDocument() {
    const inputRecipientNameEl = document.getElementById('input_recipient_name');
    const inputEngineModelEl = document.getElementById('input_engine_model');
    const inputDateEl = document.getElementById('input_date');
    const inputDocNumEl = document.getElementById('input_doc_num');
    const fioEl = document.getElementById('a_fio');
    const dvsEl = document.getElementById('a_dvs');
    const shapkaEl = document.getElementById('a_shapka');

    const fio = inputRecipientNameEl?.value || '';
    const dvs = inputEngineModelEl?.value || '';
    
    if (fioEl) fioEl.textContent = fio;
    if (dvsEl) dvsEl.textContent = dvs;

    const date = new Date(inputDateEl?.value || new Date());
    const day = date.getDate().toString();
    const genitiveMonths = ['января', 'февраля', 'марта', 'апреля', 'мая', 'июня', 'июля', 'августа', 'сентября', 'октября', 'ноября', 'декабря'];
    const month = genitiveMonths[date.getMonth()];
    const year = date.getFullYear();
    const docNum = inputDocNumEl?.value || '';
    
    if (shapkaEl) shapkaEl.innerHTML = `Заявка на&nbsp;приём/<span class="custom-underline">выдачу</span>&nbsp;груза №&nbsp;${docNum}&nbsp;от&nbsp;«${day}»&nbsp;${month}&nbsp;${year}&nbsp;г.`;
}

// --- Helper Functions ---
function populateRenderContainer(containerId, data) {
    const container = document.getElementById(containerId);
     if (!container) {
        console.error(`Container with ID "${containerId}" not found in populateRenderContainer.`);
        return; 
    }
    container.querySelectorAll('.data-field').forEach(el => el.remove());
    
    data.forEach(item => {
        if (!item.id || typeof item.id !== 'string') {
            console.error(`Invalid or missing ID in template data for container "${containerId}":`, item);
            return; 
        }
        const field = document.createElement('div');
        field.id = item.id;
        field.className = 'data-field';
        field.style.top = item.top || '0%';
        field.style.left = item.left || '0%';
        field.style.width = item.width || 'auto';
        field.style.fontSize = item.fontSize || '10pt';
        field.style.fontWeight = item.fontWeight || 'normal';
        field.style.textAlign = item.align || 'left';
        container.appendChild(field);
    });
}

async function generateExcel() {
    if (!excelTemplateFile) {
        alert("Шаблон Excel (baikal_rashod.xlsx) еще не загружен или не найден. Пожалуйста, подождите или проверьте наличие файла.");
        return;
    }
    showLoading('Подготовка Excel...');
    try {
        const workbook = new ExcelJS.Workbook();
        await workbook.xlsx.load(excelTemplateFile); 
        const worksheet = workbook.getWorksheet(1);
        
        const inputDateEl = document.getElementById('input_date');
        const inputEngineModelEl = document.getElementById('input_engine_model');
        const inputAmountEl = document.getElementById('input_amount');

        const dateValue = inputDateEl?.value;
        worksheet.getCell('B2').value = dateValue ? dateValue.split('-').reverse().join('.') : '';
        worksheet.getCell('A7').value = inputEngineModelEl?.value || '';
        const price = inputAmountEl ? parseFloat(inputAmountEl.value) : NaN;
        if (!isNaN(price)) {
            worksheet.getCell('E7').value = price;
            worksheet.getCell('F7').value = price;
        }
        const buffer = await workbook.xlsx.writeBuffer();
        saveAs(new Blob([buffer]), createFileName().replace('.pdf','.xlsx'));
    } catch (error) {
        alert("Ошибка при создании Excel файла: " + error.message);
        console.error("Excel generation error:", error);
    } finally {
        hideLoading();
    }
}
function showLoading(message) {
    const loadingText = document.getElementById('loading-text');
    const overlay = document.getElementById('loading-overlay');
    if (loadingText) loadingText.textContent = message || 'Загрузка...';
    if (overlay) overlay.classList.remove('hidden');
}
function hideLoading() {
     const overlay = document.getElementById('loading-overlay');
     if (overlay) overlay.classList.add('hidden');
}
</script>

</body>
</html>

